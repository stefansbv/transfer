# Transformation recipes
<recipe>
  version               = 1
  syntaxversion         = 1
  name                  = Test recipe
  description           = Firebird database test recipe
</recipe>

<config>
  <source>
    reader              = db
    target              = test
    table               = test_db
  </source>

  <destination>
    writer              = db
    target              = test
    table               = test_import
  </destination>
</config>

<tables>
  worksheet             =
  <table test_import>
    description         = test db table
    skiprow             = 0
    logfield            = id
    orderby             = id
    <headermap>
      id                = id
      denumire          = denumire
    </headermap>
  </table>
</tables>

<transform column/>

<transform            row>

  # a. lookupdb
  <step>
    type                = lookupdb
    datasource          = test_dict
    hints               = localitati
    <field_src>
      denumire          = localitate
    </field_src>
    method              = lookup_in_dbtable
    <field_dst>
      denloc            = localitate
    </field_dst>
    <field_dst>
      cod               = siruta
    </field_dst>
  </step>

  # b.
  <step>
    type                = lookupdb
    datasource          = test_dict
    hints               = localitati
    <field_src>
      denumire          = localitate
    </field_src>
    method              = lookup_in_dbtable
    <field_dst>
      denloc            = localitate
      cod               = siruta
    </field_dst>
  </step>

  # c.
  <step>
    type                = lookupdb
    datasource          = test_dict
    hints               = localitati
    <field_src>
      denumire          = localitate
    </field_src>
    method              = lookup_in_dbtable
    <field_dst>
      denloc            = localitate
    </field_dst>
    field_dst           = siruta
  </step>

  # d.
  <step>
    type                = lookupdb
    datasource          = test_dict
    field_src           = localitate
    method              = lookup_in_dbtable
    field_dst           = siruta
  </step>

  # d.2
  <step>
    type                = lookupdb
    datasource          = test_dict
    field_src           = localitate
    method              = lookup_in_dbtable
    field_dst           = siruta
    attributes          = IGNORECASE | IGNOREDIACRITIC
  </step>

  # e.
  # Use " to preserve space, not '
  <step>
    type                = split
    separator           = ,
    field_src           = adresa
    method              = split_field
    field_dst           = localitate
    field_dst           = strada
    field_dst           = numarul
  </step>

  # f.
  # Use " to preserve space, not '
  <step>
    type                = join
    separator           = ", "
    field_src           = localitate
    field_src           = strada
    field_src           = numarul
    method              = join_fields
    field_dst           = adresa
  </step>

  # g.
  # Scenario: a field can have only the values from the
  # datasource/valid_elts but it contains other info as well.  Move
  # this info to another field, ex: observations
  <step>
    type                = copy
    datasource          = status
    field_src           = status
    method              = move_filtered
    field_dst           = observations
    attributes          = MOVE | APPENDSRC
  </step>

  # h.
  <step>
    type                = batch
    field_src           = debit
    field_src           = credit
    method              = copy_nonzero
    field_dst           = suma
    attributes          = MOVE | REPLACENULL
  </step>

  # i.
  <step>
    type                = lookup
    datasource          = category
    field_src           = category
    method              = lookup_in_ds
    field_dst           = categ_code
  </step>
</transform>

<datasources>
  <hints localitati>
    <record>
      item              = Izvorul Mures
      hint              = Izvoru Muresului
    </record>
    <record>
      item              = Sfantu Gheorghe
      hint              = Sfintu Gheorghe
    </record>
    <record>
      item              = Podu Olt
      hint              = Podu Oltului
    </record>
  </hints>

  <valid_elts status>
    item                = Cancelled
    item                = Disputed
    item                = In Process
    item                = On Hold
    item                = Resolved
    item                = Shipped
  </valid_elts>

  <datasource category>
    <record>
      item              = Ships
      code              = S
    </record>
    <record>
      item              = Trains
      code              = T
    </record>
    <record>
      item              = Planes
      code              = P
    </record>
  </datasource>
</datasources>
